<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>{{ business.name }} — Comuni IA</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet"/>
  <link href="{{ url_for('static', filename='css/styles.css') }}" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
</head>
<body data-business-id="{{ business.id }}" data-is-owner="{{ 'true' if is_owner else 'false' }}">
<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg fixed-top">
  <div class="container">
    <a class="navbar-brand fw-bold" href="{{ url_for('home') }}">
      <i class="bi bi-chat-dots text-primary me-2"></i>Comuni IA
    </a>
    <div class="collapse navbar-collapse">
      <ul class="navbar-nav ms-auto">
        {% if not session.user_id %}
        <li class="nav-item"><a href="{{ url_for('join') }}" class="btn btn-primary ms-2">Regístrate</a></li>
        {% else %}
        <li class="nav-item"><a href="{{ url_for('logout') }}" class="btn btn-outline-primary ms-2">Salir</a></li>
        {% endif %}
      </ul>
    </div>
  </div>
</nav>

<main class="container py-5 mt-5">
  <div class="row g-4">
    <!-- COLUMNA IZQUIERDA: DETALLES DEL NEGOCIO -->
    <div class="col-md-4">
      <div class="card shadow-sm rounded-4">
        <div class="card-body text-center">
          {% if business.logo %}
          <img src="{{ url_for('static', filename='uploads/' + business.logo) }}" alt="{{ business.name }} Logo" class="img-fluid rounded-circle mb-3" style="max-height: 150px; object-fit: cover;">
          {% else %}
          <i class="bi bi-shop display-4 text-muted mb-3"></i>
          {% endif %}
          <h4 class="card-title">{{ business.name }}</h4>
          <p class="text-muted">{{ business.category }}</p>
          <p><i class="bi bi-geo-alt text-primary me-2"></i>{{ business.location }}</p>
          {% if business.phone %}<p><i class="bi bi-telephone text-primary me-2"></i>{{ business.phone }}</p>{% endif %}
          {% if business.whatsapp %}<p><i class="bi bi-whatsapp text-success me-2"></i>{{ business.whatsapp }}</p>{% endif %}
          {% if business.email %}<p><i class="bi bi-envelope text-primary me-2"></i>{{ business.email }}</p>{% endif %}
        </div>
      </div>
    </div>

    <!-- COLUMNA DERECHA: PRODUCTOS Y RESEÑAS -->
    <div class="col-md-8">
      <!-- SECCIÓN PRODUCTOS -->
      <div class="card shadow-sm rounded-4 mb-4">
        <div class="card-body">
          <h5>Productos</h5>
          {% if is_owner %}
          <button class="btn btn-primary btn-sm mb-3" data-bs-toggle="modal" data-bs-target="#addProductModal">
            <i class="bi bi-plus-lg"></i> Agregar Producto
          </button>
          {% endif %}
          <div id="products-list" class="row g-3">
            {% for product in products %}
            <div class="col-md-6">
              <div class="card h-100">
                <div class="card-body">
                  {% if product.image_url %}
                  <img src="{{ url_for('static', filename='uploads/' + product.image_url) }}" alt="{{ product.name }}" class="img-fluid mb-2" style="max-height: 100px; object-fit: cover;">
                  {% else %}
                  <i class="bi bi-image display-5 text-muted mb-2"></i>
                  {% endif %}
                  <h6 class="card-title">{{ product.name }}</h6>
                  <p class="text-muted">Bs. {{ "%.2f"|format(product.price) }}</p>
                  {% if is_owner %}
                  <button class="btn btn-danger btn-sm delete-product" data-id="{{ product.id }}" onclick="deleteProduct(this)">
                    <i class="bi bi-trash"></i> Eliminar
                  </button>
                  {% endif %}
                </div>
              </div>
            </div>
            {% else %}
            <p id="no-products-msg" class="text-muted">No hay productos.</p>
            {% endfor %}
          </div>
        </div>
      </div>

      <!-- SECCIÓN RESEÑAS -->
      <div class="card shadow-sm rounded-4">
        <div class="card-body">
          <h5>Reseñas <span class="badge bg-primary">{{ reviews|length }}</span></h5>
          <p class="text-muted">Promedio: {{ avg_rating }}/5</p>
          {% for review in reviews %}
          <div class="card mb-2 shadow-sm">
            <div class="card-body p-3">
              <p class="mb-0"><strong>{{ review.author }}</strong> - {{ review.rating }}/5</p>
              <small class="text-muted">{{ review.created_at }}</small>
              <p class="mb-0">{{ review.comment }}</p>
            </div>
          </div>
          {% else %}
          <p class="text-muted">No hay reseñas.</p>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</main>

<!-- MODAL AGREGAR PRODUCTO -->
<div class="modal fade" id="addProductModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Agregar Producto</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="addProductForm">
          <div class="mb-3">
            <label class="form-label">Nombre</label>
            <input type="text" class="form-control" name="name" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Precio (Bs)</label>
            <input type="number" class="form-control" name="price" step="0.01" min="0" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Imagen</label>
            <input type="file" class="form-control" name="image" accept="image/*">
            <small class="text-muted">Opcional (JPG, PNG)</small>
          </div>
          <button type="submit" class="btn btn-primary">Guardar</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const addProductForm = document.getElementById('addProductForm');
  const addProductModal = new bootstrap.Modal(document.getElementById('addProductModal'));
  const productsList = document.getElementById('products-list');
  const noProductsMsg = document.getElementById('no-products-msg');
  const businessId = document.body.dataset.businessId;

  // --- AGREGAR PRODUCTO ---
  addProductForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);

    try {
      const resp = await fetch(`/api/products/${businessId}`, {
        method: 'POST',
        body: formData
      });
      const data = await resp.json();
      if (data.success) {
        addProductToDOM(data.product);
        addProductForm.reset();
        addProductModal.hide();
        alert('Producto agregado con éxito.');
      } else {
        alert('Error: ' + (data.error || 'No se pudo agregar el producto.'));
      }
    } catch (err) {
      alert('Error de conexión al agregar el producto.');
    }
  });

  // --- ELIMINAR PRODUCTO ---
  async function deleteProduct(button) {
    const productId = button.dataset.id;
    if (!confirm('¿Seguro que quieres eliminar este producto?')) return;

    try {
      const resp = await fetch(`/api/products/${productId}`, { method: 'DELETE' });
      const data = await resp.json();
      if (data.success) {
        // Eliminar el producto del DOM
        const productCard = button.closest('.col-md-6');
        productCard.remove();
        if (productsList.children.length === 1 && productsList.children[0].id === 'no-products-msg') {
             noProductsMsg.style.display = 'block';
        }
        alert('Producto eliminado.');
      } else {
        alert('Error: ' + (data.error || 'No se pudo eliminar.'));
      }
    } catch (err) {
      alert('Error de conexión al eliminar.');
    }
  }

  // --- FUNCIÓN PARA AÑADIR PRODUCTO AL DOM ---
  function addProductToDOM(product) {
    if (noProductsMsg) {
      noProductsMsg.style.display = 'none';
    }

    const imageUrl = product.image_url 
      ? `/static/uploads/${product.image_url}` 
      : '';

    const productHTML = `
      <div class="col-md-6">
        <div class="card h-100">
          <div class="card-body">
            ${imageUrl 
              ? `<img src="${imageUrl}" alt="${product.name}" class="img-fluid mb-2" style="max-height: 100px; object-fit: cover;">`
              : `<i class="bi bi-image display-5 text-muted mb-2"></i>`
            }
            <h6 class="card-title">${product.name}</h6>
            <p class="text-muted">Bs. ${parseFloat(product.price).toFixed(2)}</p>
            <button class="btn btn-danger btn-sm delete-product" data-id="${product.id}" onclick="deleteProduct(this)">
              <i class="bi bi-trash"></i> Eliminar
            </button>
          </div>
        </div>
      </div>
    `;
    productsList.insertAdjacentHTML('beforeend', productHTML);
  }

  // Asignar el evento a los botones ya existentes
  document.querySelectorAll('.delete-product').forEach(btn => btn.onclick = () => deleteProduct(btn));
</script>
</body>
</html>